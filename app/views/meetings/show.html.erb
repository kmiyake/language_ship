<% content_for :javascript do %>
  <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
  <script>
    (function() {

      var geocoder = new google.maps.Geocoder();
      var place = $("#address").text();

      geocoder.geocode({
        address: place
      }, function(results, status) {
        if (status == google.maps.GeocoderStatus.OK) {
          var lat = results[0].geometry.location.lat();
          var lng = results[0].geometry.location.lng();
          var latlng = new google.maps.LatLng(lat, lng);
          var myOptions = {
            zoom: 19,
            center: latlng,
            disableDefaultUI: true,
            mapTypeId: google.maps.MapTypeId.ROADMAP
          };

          var map = new google.maps.Map(document.getElementById("google-map"), myOptions);

          var marker = new google.maps.Marker({
            position: latlng,
            map: map,
            title: "<%= @meeting.location %>"
          });
        } else if (status == google.maps.GeocoderStatus.ERROR) {
          // alert("サーバとの通信時に何らかのエラーが発生！");
        } else if (status == google.maps.GeocoderStatus.INVALID_REQUEST) {
          // alert("リクエストに問題アリ！geocode()に渡すGeocoderRequestを確認せよ！！");
        } else if (status == google.maps.GeocoderStatus.OVER_QUERY_LIMIT) {
          // alert("短時間にクエリを送りすぎ！落ち着いて！！");
        } else if (status == google.maps.GeocoderStatus.REQUEST_DENIED) {
          // alert("このページではジオコーダの利用が許可されていない！・・・なぜ！？");
        } else if (status == google.maps.GeocoderStatus.UNKNOWN_ERROR) {
          // alert("サーバ側でなんらかのトラブルが発生した模様。再挑戦されたし。");
        } else if (status == google.maps.GeocoderStatus.ZERO_RESULTS) {
          // alert("見つかりません");
        } else {
          // alert("えぇ～っと・・、バージョンアップ？");
        }
      });
    })();
  </script>
<% end %>
<div class="row">
  <div class="span4">
    <b><%= t '.owner' %></b>
    <p><%= image_tag "https://graph.facebook.com/#{@meeting.user.uid}/picture?type=normal", class: "img-circle" %></p>
    <p><%= link_to @meeting.user.name, "/#{@meeting.user.profile_url}" %></p>
    <b><%= t '.message' %></b>
    <p>
      <%= @meeting.message %>
    </p>
    <b><%= t '.native_language' %></b>
    <p>
      <%= t @meeting.user.native_language, scope: :language %>
    </p>
    <b><%= t '.learn_language' %></b>
    <p>
      <%= t @meeting.user.learn_language, scope: :language %>
    </p>
  </div>
  <div class="span4">
    <b><%= t '.date' %></b>
    <p><%= @meeting.date %></p>
    <b><%= t '.time' %></b>
    <p><%= @meeting.render_time %></p>
    <b><%= t '.teach_language' %></b>
    <p><%= t @meeting.teach_language, :scope => 'language' %></p>
    <b><%= t '.study_language' %></b>
    <p><%= t @meeting.study_language, :scope => 'language' %></p>
    <b><%= t '.location' %></b>
    <p><%= @meeting.location %></p>
    <p id="address"><%= @meeting.address %></p>
    <p id="google-map" style="width:250px;height:250px">
    </p>
  </div>
  <div class="span4">
    <% if current_user %>
      <p>
        <% if @meeting.success %>
          <b><%= t '.guest' %></b>
          <p><%= image_tag "https://graph.facebook.com/#{@meeting.guest_user.uid}/picture?type=normal", class: "img-circle" %></p>
          <p><%= link_to @meeting.guest_user.name, "/#{@meeting.guest_user.profile_url}" %></p>
          <b><%= t '.native_language' %></b>
          <p>
            <%= t @meeting.guest_user.native_language, scope: :language %>
          </p>
          <b><%= t '.learn_language' %></b>
          <p>
            <%= t @meeting.guest_user.learn_language, scope: :language %>
          </p>
        <% else %>
          <% unless @meeting.is_past? %>
            <p><%= t '.the_number_of_application' %> <%= @meeting.appointments.count %></p>
          <% end %>
          <% if current_user == @meeting.user %>
            <% @meeting.appointments.each do |appointment| %>
              <%= form_tag accept_meeting_appointment_path(appointment.meeting.id, appointment), class: "form-inline", method: :put do %>
                <%= link_to appointment.sender.name, "/#{appointment.sender.profile_url}" %>
                <%= appointment.message %>
                <%= submit_tag t('.accept'), class: "btn" %>
              <% end %>
            <% end %>
          <% end %>
        <% end %>

        <% if current_user.id != @meeting.user.id && !@meeting.success && @meeting.date >= Date.today %>
          <% if @meeting.appointments.exists?(sender_id: current_user.id) %>
            <%= link_to t('.cancel'), meeting_appointment_path(@meeting),
              method: :delete, confirm: t('are_you_sure'), class: "btn btn-danger" %>
          <% else %>
            <%= link_to t('.study_with'), new_meeting_appointment_path(@meeting), class: "btn btn-primary" %>
          <% end %>
        <% end %>
      </p>

      <p>
        <% if current_user.id == @meeting.user.id && @meeting.date > Date.today %>
          <%= link_to t('.edit'), edit_meeting_path(@meeting), class: "btn" %>
          <%= link_to t('.destory'), @meeting, method: :delete, confirm: t('are_you_sure'), class: "btn btn-danger" %>
        <% end %>
      </p>
    <% end %>
  </div>
</div>
